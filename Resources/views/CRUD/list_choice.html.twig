{#

This file is part of the Sonata package.

(c) Thomas Rabaix <thomas.rabaix@sonata-project.org>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{% extends admin.getTemplate('base_list_field') %}

{% set isEditable = ( field_description.options.multiple is not defined or not field_description.options.multiple ) and field_description.options.choices is defined  and field_description.options.editable is defined and field_description.options.editable and admin.isGranted('EDIT', object) %}
{% set xEditableType = field_description.type|sonata_xeditable_type %}

{% if isEditable and xEditableType %}
    {% if field_description.options.empty_data is defined or field_description.options.empty_value is defined %}
    {% set  editableEmpty = "{value:'" ~ ( field_description.options.empty_data is defined ? field_description.options.empty_data|e : '' ) ~ "', text:'" ~ ( field_description.options.empty_value is defined ? field_description.options.empty_value|e : '' ) ~ "'}," %}
    {% else %}
    {% set  editableEmpty = '' %}
    {% endif %}
    {% block field_span_attributes %}
        {% spaceless %}
            {{ parent() }}
            data-source="[{{ editableEmpty|raw }}{% for key,data in field_description.options.choices %}{ value: '{{ key }}', text: '{{ data }}' }{{ loop.last ? '': ',' }}{% endfor %}]"
        {% endspaceless %}
    {% endblock %}
{% endif %}


{% block field %}
{% spaceless %}
    {% if field_description.options.choices  is defined %}
        {% if field_description.options.multiple is defined and field_description.options.multiple==true and value is iterable %}

            {% set result = '' %}
            {% set delimiter = field_description.options.delimiter|default(', ') %}

            {% for val in value %}
                {% if result is not empty %}
                    {% set result = result ~ delimiter %}
                {% endif %}

                {% if field_description.options.choices[val] is defined %}
                    {% if field_description.options.catalogue is not defined %}
                        {% set result = result ~ field_description.options.choices[val] %}
                    {% else %}
                        {% set result = result ~ field_description.options.choices[val]|trans({}, field_description.options.catalogue) %}
                    {% endif %}
                {% else %}
                    {% set result = result ~ val %}
                {% endif %}
            {% endfor %}

            {% set value = result %}

        {% elseif value in field_description.options.choices|keys %}
            {% if field_description.options.catalogue is not defined %}
                {% set value = field_description.options.choices[value] %}
            {% else %}
                {% set value = field_description.options.choices[value]|trans({}, field_description.options.catalogue) %}
            {% endif %}
        {% endif %}
    {% endif %}

    {{ value }}
{% endspaceless %}
{% endblock %}
